<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>게시글 상세보기</title>
</head>
<body>
<h2>📌 게시글 상세</h2>

<p><strong>제목:</strong> <span th:text="${post.title}">제목</span></p>
<p><strong>내용:</strong></p>
<p th:text="${post.content}">내용</p>

<!-- 첨부파일 구분 표시 -->
<div th:if="${post.storedFilename != null}">
  <div th:if="${post.isImage}">
    <img th:src="@{'/uploads/|${post.storedFilename}|'}" width="300">
  </div>
  <div th:unless="${post.isImage}">
    <a th:href="@{'/uploads/|${post.storedFilename}|'}"
       download
       th:text="${post.originalFilename}">파일 다운로드</a>
  </div>
</div>

<hr>

<!-- ✅ 댓글 작성 폼 -->
<h3>💬 댓글 작성</h3>
<form th:action="@{/comment/add}" method="post">
  <input type="hidden" name="postId" th:value="${post.id}">
  <textarea name="content" rows="3" cols="50" required></textarea><br>
  <button type="submit">등록</button>
</form>

<hr>

<!-- ✅ 댓글 리스트-->
<h3>🗨 댓글</h3>
<ul>
  <!-- ✅ 댓글 삭제 버튼: ID가 null인 경우 파싱 방지 -->
  <li th:each="comment : ${comments}">
    <strong th:text="${comment.author ?: '익명'}">작성자</strong> -
    <span th:text="${comment.createdAt != null ? #temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm') : '시간 없음'}">작성시간</span><br>
    <span th:text="${comment.content ?: '내용 없음'}">댓글 내용</span>

    <!-- 🔒 null-safe 삭제 버튼 처리 -->
    <div th:if="${loginUser != null and comment.author == loginUser and comment.id != null and post != null and post.id != null}">
      <form th:action="@{/comment/delete/{id}(id=${comment.id})}" method="get">
        <input type="hidden" name="postId" th:value="${post.id}">
        <button type="submit">삭제</button>
      </form>
    </div>

    <br><br>
  </li>

</ul>


<!-- 수정 / 삭제 버튼 -->
<form th:action="@{'/posts/' + ${post.id} + '/delete'}" method="post" style="display:inline;">
  <button type="submit" onclick="return confirm('정말 삭제하시겠습니까?')">🗑 삭제</button>
</form>
<a th:href="@{'/posts/' + ${post.id} + '/edit'}">
  <button>✏️ 수정</button>
</a>

<!-- 네비게이션 -->
<br><br>
<a href="/posts">🔙 목록으로 돌아가기</a>
<a href="/main">
  <button>🏠 홈으로</button>
</a>
</body>
</html>
